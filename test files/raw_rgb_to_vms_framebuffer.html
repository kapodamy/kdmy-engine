<!DOCTYPE html>
<html>

<body>
	<input type="file" />
	<br>
	<br>
	<label><input type="checkbox" id="bg" checked /> background is white</label>
	<br>
	<label><input type="checkbox" id="1x1" />1 pixel per byte</label>
	<br>
	<br>
	<strong>output:</strong>
	<br>
	<textarea></textarea>

	<script type="text/javascript">
		document.querySelector("input[type=file]").addEventListener("change", function () {
			process_file(this.files[0]);
			this.value = "";
		});

		function convert_rgb8_to_monochrome(/**@type {number}*/r, /**@type {number}*/g, /**@type {number}*/b) {
			return r > 127 || g > 127 || b > 127;
		}

		function convert_typed_array_to_hex_array(/**@type {Uint8Array}*/array, /**@type {boolean}*/as_array) {
			let str = "";
			let arr = as_array ? array : (new Uint32Array(array.buffer));
			let pad = as_array ? 2 : 8;
			for (let i = 0; i < arr.length; i++) {
				let byte = arr[i].toString(16).padStart(pad, '0');

				if (as_array)
					str += "0x" + byte + ", ";
				else
					str += byte;
			}

			return str.substring(0, str.length - 2);
		}

		async function process_file(file) {
			let bg = document.getElementById("bg").checked;
			let no_rgb = document.getElementById("1x1").checked;
			let rgb8_data = new Uint8Array(await file.arrayBuffer());
			let monochrome_data = new Uint8Array((48 * 32) / 8);
			let byte = 0x00;
			let bit_index = 7;
			let j = 0;
			let preview = "";
			let width = 0;
			let step = no_rgb ? 1 : 3;

			monochrome_data.fill(0x0000);

			for (let i = 0; i < rgb8_data.length; i += step) {
				let texel = 0x00;
				if (no_rgb)
					texel = rgb8_data[i] > 0 ? 1 : 0;
				else
					texel = convert_rgb8_to_monochrome(rgb8_data[i + 0], rgb8_data[i + 1], rgb8_data[i + 2]);

				if (bg) texel = !texel;

				if (texel) {
					byte |= 0x01 << bit_index;
				}

				preview += texel ? "██" : "░░";
				width++;
				if (width >= 48) {
					width = 0;
					preview += "\r\n";
				}

				bit_index--;
				if (bit_index < 0) {
					monochrome_data[j] = byte;
					j++;

					bit_index = 7;
					byte = 0x00;
				}
			}

			if (byte != 0x00) {
				monochrome_data[j] = byte;
			}

			let hex_framebuffer = convert_typed_array_to_hex_array(monochrome_data, true);
			let hex_string = convert_typed_array_to_hex_array(monochrome_data, false);

			let str = `const FRAMEBUFFER_BITMAP = new Uint32Array([${hex_framebuffer}]);\r\n`;
			str += `const FRAMEBUFFER_STRING = "${hex_string}";`;
			str += `\r\n\r\n/*\r\n${preview}\r\n*/\r\n`;

			document.querySelector("textarea").value = str;
		}

	</script>
</body>

</html>